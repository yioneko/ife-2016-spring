import"./dynamic-import-polyfill.301f8c0f.js";const t=document.querySelector("canvas");t.width=800,t.height=800;const e=t.getContext("2d"),i=document.querySelector(".console"),s=document.querySelector(".msg .state"),a=document.querySelector(".msg .command");class n{constructor(t,e){this.id=t,this.fuel=100,this.totalDistance=0,this.speed=20,this.radius=e,this.flying=!1,this.destroyed=!0,this.fuelConsumptionSpeed=5,this.fuelChargeSpeed=2,this.width=65,this.height=30}receiveCommand(t){if(this.id===t.id){if("create"===t.operation&&this.destroyed)return this.initialize(),!0;if("start"===t.operation)this.flying=!0;else if("stop"===t.operation)this.flying=!1;else if("destroy"===t.operation)return this.destroyed=!0,!0}return!1}updateState(t){if(t/=1e3,!this.destroyed){const e=this.fuel-(this.fuelConsumptionSpeed-this.fuelChargeSpeed)*t;if(this.flying)if(e<=0){this.flying=!1;const e=this.fuel/(this.fuelConsumptionSpeed-this.fuelChargeSpeed);this.totalDistance+=e*this.speed,this.fuel=(t-e)*this.fuelChargeSpeed}else this.fuel=e,this.totalDistance+=t*this.speed;else this.fuel+=this.fuelChargeSpeed*t;this.fuel=Math.min(this.fuel,100),this.draw()}}initialize(){this.fuel=100,this.totalDistance=0,this.flying=!1,this.destroyed=!1}draw(){e.save(),e.translate(t.width/2,t.height/2),e.rotate(this.totalDistance/this.radius),e.translate(0,-this.radius),e.fillStyle="#7d8597",e.beginPath(),e.rect(-this.width/2,-this.height/2,this.width,this.height),e.arc(this.width/2,0,this.height/2,-Math.PI/2,Math.PI/2),e.arc(-this.width/2,0,this.height/2,-Math.PI/2,Math.PI/2,!0),e.fill(),e.beginPath(),e.fillStyle="#0353a4",e.arc(-this.width/2+this.height/2,0,this.height/2*Math.sqrt(2),Math.PI/4*3,Math.PI/4*5),e.arc(-this.width/2,0,this.height/2,-Math.PI/2,Math.PI/2,!0),e.fill(),e.beginPath(),e.fillStyle="#caf0f8",e.font="15px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(`${this.id}号-${this.fuel.toFixed(0)}%`,0,0),e.restore()}}const h=[new n(1,100),new n(2,150),new n(3,200),new n(4,250)],o=class{static spreadCommand(t){if(Math.random()>=o.failureRate){s.toggleAttribute("fail",!1),s.innerHTML="Success";for(const e of h)setTimeout((()=>{e.receiveCommand(t)&&o.updateDom(t)}),o.spreadTime)}else s.toggleAttribute("fail",!0),s.innerHTML="Fail";a.innerHTML=JSON.stringify(t)}static updateDom(t){const e=i.querySelector(`.spaceship${t.id}-commands`);if(e)switch(t.operation){case"create":e.classList.remove("destroyed");break;case"destroy":e.classList.add("destroyed")}}};let r=o;r.failureRate=.3,r.spreadTime=1e3;for(let c=1;c<=4;++c){const t=document.createElement("div");t.className=`spaceship${c}-commands destroyed`;const e=document.createElement("label");e.innerHTML=`对${c}号飞船下达指令：`,t.appendChild(e);const s=document.createElement("button");s.innerHTML="开始飞行",s.className="start-button",s.addEventListener("click",(()=>{r.spreadCommand({id:c,operation:"start"})})),t.appendChild(s);const a=document.createElement("button");a.innerHTML="停止飞行",a.className="stop-button",a.addEventListener("click",(()=>{r.spreadCommand({id:c,operation:"stop"})})),t.appendChild(a);const n=document.createElement("button");n.innerHTML="销毁",n.className="destroy-button",n.addEventListener("click",(()=>{r.spreadCommand({id:c,operation:"destroy"})})),t.appendChild(n),i.appendChild(t)}const d=document.createElement("button");d.innerHTML="新的飞船起飞",d.className="destroy-button",d.addEventListener("click",(()=>{for(let t=0;t<4;++t)if(h[t].destroyed)return void r.spreadCommand({id:t+1,operation:"create"})})),i.appendChild(d);let l=0;requestAnimationFrame((function i(s){e.clearRect(0,0,t.width,t.height),e.save(),e.beginPath(),e.fillStyle="#0353a4",e.translate(t.width/2,t.height/2),e.arc(0,0,50,0,2*Math.PI),e.fill(),e.restore();for(const t of h)t.updateState(l?s-l:0);l=s,requestAnimationFrame(i)}));
