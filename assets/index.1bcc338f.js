import"./dynamic-import-polyfill.301f8c0f.js";const e=document.querySelector("canvas"),t=e.getContext("2d"),i=document.querySelector(".msg .try-info"),s=document.querySelector(".msg .command");var n,a;(a=n||(n={}))[a.create=0]="create",a[a.start=1]="start",a[a.stop=2]="stop",a[a.destroy=3]="destroy";const r=[null,null,null,null],o=[{name:"劲量型",fuelChargeSpeed:2,description:"劲量型（补充能源速度2%/s）"},{name:"光能型",fuelChargeSpeed:3,description:"劲量型（补充能源速度2%/s）"},{name:"永久型",fuelChargeSpeed:4,description:"永久型（补充能源速度4%/s）"}],d=[{name:"前进号",speed:30,fuelConsumptionSpeed:5,description:"前进号（速率30px/s,能耗5%/s）"},{name:"奔腾号",speed:50,fuelConsumptionSpeed:7,description:"奔腾号（速率50px/s,能耗7%/s）"},{name:"超越号",speed:80,fuelConsumptionSpeed:9,description:"超越号（速率80px/s,能耗9%/s）"}],l=class{static stateDecoder(e){const t=255&e,i=3&(e>>=8),s=3&(e>>=2),n=3&(e>>=2);return{id:(e>>=2)+1,dynamic:d[n].name,energy:o[s].name,state:["停止","飞行中","即将销毁",null][i],fuel:t}}static processSpaceshipSignal(e){const t=l.stateDecoder(e),i=t.id-1;let s=l.trList[i];if(s&&null===t.state)this.trList[i]=null,l.monitorTableBody.removeChild(s);else if(null!==t.state){if(null===s){s=document.createElement("tr");let e=i;for(;e<this.trList.length;++e)if(null!==this.trList[e]){l.monitorTableBody.insertBefore(s,this.trList[e]);break}e===this.trList.length&&l.monitorTableBody.appendChild(s),this.trList[i]=s}s.innerHTML=`<td>${t.id}号</td><td>${t.dynamic}</td><td>${t.energy}</td><td>${t.state}</td><td>${t.fuel}%</td>`}}};let c=l;c.monitorTableBody=document.querySelector(".monitor tbody"),c.trList=[null,null,null,null];const h=class{static simulateTry(e){let t=1;!function s(){setTimeout((()=>{Math.random()<h.failureRate?(++t,setTimeout(s,h.retryInterval)):(i.innerHTML=`Tried ${t} times:`,e())}),h.spreadTime)}()}static spreadCommand(e){h.simulateTry((()=>{for(const t of r)t&&t.receiveCommand(this.commandEncoder(e))&&h.updateDom(e);s.innerHTML=JSON.stringify(e)}))}static updateDom(e){const t=document.querySelector(`.spaceship${e.id}-commands`);if(t)switch(e.operation){case"create":t.classList.remove("destroyed");break;case"destroy":t.classList.add("destroyed")}}static transmitSpaceshipSignal(e){c.processSpaceshipSignal(e)}static commandEncoder(e){return e.id-1<<2|n[e.operation]}};let u=h;u.failureRate=.1,u.spreadTime=300,u.retryInterval=500;class m{constructor(e,t,i,s,n,a,r){this.id=e,this.fuel=100,this.totalDistance=0,this.speed=i,this.radius=t,this.flying=!1,this.destroying=!1,this.destroyTime=500,this.fuelConsumptionSpeed=s,this.fuelChargeSpeed=n,this.width=65,this.height=30,this.dynamicSelectionId=a,this.energySelectionId=r,this.broadcastInterval=200,this.broadcastId=setInterval((()=>{this.broadcast()}),this.broadcastInterval)}receiveCommand(e){const t=this.commandDecoder(e);if(this.id===t.id)if("start"===t.operation)this.flying=!0;else if("stop"===t.operation)this.flying=!1;else if("destroy"===t.operation)return this.destroying=!0,setTimeout((()=>{clearTimeout(this.broadcastId),this.broadcast(3),r[this.id-1]=null}),this.destroyTime),!0;return!1}updateState(e){e/=1e3;const t=this.fuel-(this.fuelConsumptionSpeed-this.fuelChargeSpeed)*e;if(this.flying)if(t<=0){this.flying=!1;const t=this.fuel/(this.fuelConsumptionSpeed-this.fuelChargeSpeed);this.totalDistance+=t*this.speed,this.fuel=(e-t)*this.fuelChargeSpeed}else this.fuel=t,this.totalDistance+=e*this.speed;else this.fuel+=this.fuelChargeSpeed*e;this.fuel=Math.min(this.fuel,100),this.draw()}draw(){t.save(),t.translate(e.width/2,e.height/2),t.rotate(this.totalDistance/this.radius),t.translate(0,-this.radius),t.fillStyle="#7d8597",t.beginPath(),t.rect(-this.width/2,-this.height/2,this.width,this.height),t.arc(this.width/2,0,this.height/2,-Math.PI/2,Math.PI/2),t.arc(-this.width/2,0,this.height/2,-Math.PI/2,Math.PI/2,!0),t.fill(),t.beginPath(),t.fillStyle="#0353a4",t.arc(-this.width/2+this.height/2,0,this.height/2*Math.sqrt(2),Math.PI/4*3,Math.PI/4*5),t.arc(-this.width/2,0,this.height/2,-Math.PI/2,Math.PI/2,!0),t.fill(),t.beginPath(),t.fillStyle="#caf0f8",t.font="15px sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText(`${this.id}号-${this.fuel.toFixed(0)}%`,0,0),t.restore()}commandDecoder(e){return{id:1+(e>>2),operation:n[3&e]}}stateEncoder(e){return void 0===e&&(e=this.destroying?2:this.flying?1:0),[[2,this.dynamicSelectionId],[2,this.energySelectionId],[2,e],[8,this.fuel]].reduce(((e,t)=>(e<<t[0])+t[1]),this.id-1)}broadcast(e){const t=this.stateEncoder(e);u.transmitSpaceshipSignal(t)}}function p(e,t,i){for(let s=0;s<i.length;s++){const n=document.createElement("input");n.type="radio",n.name=e,n.id=`type-${s}`,n.value=s.toString(),0===s&&(n.checked=!0);const a=document.createElement("label");a.htmlFor=n.id,a.innerHTML=i[s].description;const r=document.createElement("div");r.className=n.id,r.appendChild(n),r.appendChild(a),t.appendChild(r)}}e.width=1e3,e.height=800,p("dynamic",document.querySelector(".dynamic-select"),d),p("energy",document.querySelector(".energy-select"),o);const f=document.querySelector(".control-console");for(let T=1;T<=4;++T){const e=document.createElement("div");e.className=`spaceship${T}-commands destroyed`;const t=document.createElement("label");t.innerHTML=`对${T}号飞船下达指令：`,e.appendChild(t);const i=document.createElement("button");i.innerHTML="开始飞行",i.className="start-button",i.addEventListener("click",(()=>{u.spreadCommand({id:T,operation:"start"})})),e.appendChild(i);const s=document.createElement("button");s.innerHTML="停止飞行",s.className="stop-button",s.addEventListener("click",(()=>{u.spreadCommand({id:T,operation:"stop"})})),e.appendChild(s);const n=document.createElement("button");n.innerHTML="销毁",n.className="destroy-button",n.addEventListener("click",(()=>{u.spreadCommand({id:T,operation:"destroy"})})),e.appendChild(n),f.appendChild(e)}const y=document.querySelector(".create-console"),g=y.dynamic,S=y.energy;document.querySelector(".create-button").addEventListener("click",(()=>{for(let e=0;e<4;++e)if(null===r[e]){const t=parseInt(g.value),i=parseInt(S.value),n=d[t],a=o[i];return void u.simulateTry((()=>{r[e]=new m(e+1,90*(e+1),n.speed,n.fuelConsumptionSpeed,a.fuelChargeSpeed,t,i),s.innerHTML=`Create spaceship: ${e+1}`,u.updateDom({id:e+1,operation:"create"})}))}i.innerHTML="",s.innerHTML="No spaceship to create"}));let C=0;requestAnimationFrame((function i(s){t.clearRect(0,0,e.width,e.height),t.save(),t.beginPath(),t.fillStyle="#0353a4",t.translate(e.width/2,e.height/2),t.arc(0,0,50,0,2*Math.PI),t.fill(),t.restore();for(const e of r)null==e||e.updateState(C?s-C:0);C=s,requestAnimationFrame(i)}));
